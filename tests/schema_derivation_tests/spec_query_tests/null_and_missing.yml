%YAML 1.2
---
catalog_schema: {foo: {bar: {bsonType: object, required: [_id, a, c], additionalProperties: true,
      properties: {_id: {bsonType: int}, a: {bsonType: int}, b: {bsonType: !!str "null"},
        c: {bsonType: object, required: [d], additionalProperties: true, properties: {
            d: {bsonType: string}, e: {bsonType: int}}}}}}}

tests:
- description: Normal non-missing reference
  current_db: foo
  query: SELECT a FROM bar
  result_set_schema:
    bsonType: object
    properties:
      _id: {bsonType: objectId}
      '':
        bsonType: object
        properties:
          a: {bsonType: int}
        required: [a]
        additionalProperties: false
    required: ['', _id]
    additionalProperties: false
- description: NULL vs MISSING in direct field ref
  current_db: foo
  query: SELECT b FROM bar
  result_set_schema:
    bsonType: object
    properties:
      _id: {bsonType: objectId}
      '':
        bsonType: object
        properties:
          b: {bsonType: 'null'}
        additionalProperties: false
    required: ['', _id]
    additionalProperties: false
- description: Normal field access
  current_db: foo
  query: SELECT c.d FROM bar
  result_set_schema:
    bsonType: object
    properties:
      _id: {bsonType: objectId}
      '':
        bsonType: object
        properties:
          d: {bsonType: string}
        required: [d]
        additionalProperties: false
    required: ['', _id]
    additionalProperties: false
- description: Scalar vs missing field ref
  current_db: foo
  query: SELECT c.e FROM bar
  result_set_schema:
    bsonType: object
    properties:
      '':
        bsonType: object
        properties:
          e: {bsonType: int}
        additionalProperties: false
      _id: {bsonType: objectId}
    required: ['', _id]
    additionalProperties: false
- description: Scalar vs missing field ref- the field ref is upgraded to NULL because
    of plus sign
  current_db: foo
  query: SELECT a, c.e, a + c.e FROM bar
  result_set_schema:
    bsonType: object
    properties:
      '':
        bsonType: object
        properties:
          e: {bsonType: int}
          _3:
            anyOf:
            - {bsonType: 'null'}
            - {bsonType: int}
          a: {bsonType: int}
        required: [_3, a]
        additionalProperties: false
      _id: {bsonType: objectId}
    required: ['', _id]
    additionalProperties: false
- description: MISSING upgraded to NULL due to plus sign
  current_db: foo
  query: SELECT b, c.e, b + c.e FROM bar
  result_set_schema:
    bsonType: object
    properties:
      '':
        bsonType: object
        properties:
          e: {bsonType: int}
          _3: {bsonType: 'null'}
          b: {bsonType: 'null'}
        required: [_3]
        additionalProperties: false
      _id: {bsonType: objectId}
    required: ['', _id]
    additionalProperties: false
- description: MISSING fields in arrays are upgrade to NULLS
  current_db: foo
  query: SELECT [b, 2, c.e] AS arr FROM bar
  result_set_schema:
    bsonType: object
    properties:
      '':
        bsonType: object
        properties:
          arr:
            bsonType: array
            items:
              anyOf:
              - {bsonType: 'null'}
              - {bsonType: int}
        required: [arr]
        additionalProperties: false
      _id: {bsonType: objectId}
    required: ['', _id]
    additionalProperties: false
