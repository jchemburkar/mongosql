catalog_schema:
  {
    "mydb":
      {
        "biz":
          {
            "bsonType": "object",
            "required": ["_id", "foo"],
            "additionalProperties": false,
            "properties":
              { "_id": { "bsonType": "int" }, "foo": { "bsonType": "int" } },
          },
        "bar":
          {
            "bsonType": "object",
            "required": ["_id", "foo"],
            "additionalProperties": false,
            "properties":
              {
                "_id": { "bsonType": "int" },
                "foo": { "bsonType": "int" },
                "baz": { "bsonType": "int" },
              },
          },
        "baz":
          {
            "bsonType": "object",
            "required": ["bar", "car"],
            "additionalProperties": false,
            "properties":
              { "_id": { "bsonType": "int" }, "bar": { "bsonType": "int" }, "car": { "bsonType": "int" } },
          },
      },
  }

tests:
- description: WITH clause simple query
  current_db: mydb
  "pipeline": [
    {
      "$project": {
        "_id": 0, 
        "biz": "$$ROOT"
      }
    }, 
    {
      "$project": {
        "__bot": {
          "foo": "$biz.foo"
        }, 
        "_id": 0
      }
    }, 
    {
      "$project": {
        "_id": 0, 
        "t": "$__bot"
      }
    }
  ]
  result_set_schema:
    bsonType: object
    properties:
      _id: {bsonType: objectId}
      t:
        bsonType: object
        properties:
          foo: {bsonType: int}
        required: [foo]
        additionalProperties: false
    required: [_id, t]
    additionalProperties: false
- description: WITH clause join query
  current_db: mydb
  "pipeline": [
    {
      "$project": {
        "_id": 0, 
        "biz": "$$ROOT"
      }
    }, 
    {
      "$lookup": {
        "from": "baz", 
        "pipeline": [
          {
            "$match": {
              "$expr": {
                "$and": [
                  {
                    "$gt": [
                      "$_id", 
                      {
                        "$literal": null
                      }
                    ]
                  }, 
                  {
                    "$eq": [
                      "$$vbiz_1._id", 
                      "$_id"
                    ]
                  }
                ]
              }
            }
          }, 
          {
            "$project": {
              "_id": 0, 
              "baz": "$$ROOT"
            }
          }
        ], 
        "let": {
          "vbiz_1": "$biz"
        }, 
        "as": "eca58228-b657-498a-b76e-f48a9161a404"
      }
    }, 
    {
      "$unwind": {
        "path": "$eca58228-b657-498a-b76e-f48a9161a404"
      }
    }, 
    {
      "$replaceWith": {
        "$mergeObjects": [
          "$$ROOT", 
          "$eca58228-b657-498a-b76e-f48a9161a404"
        ]
      }
    }, 
    {
      "$project": {
        "eca58228-b657-498a-b76e-f48a9161a404": 0, 
        "_id": 0
      }
    }, 
    {
      "$project": {
        "__bot": {
          "car": "$baz.car", 
          "foo": "$biz.foo", 
          "bar": "$baz.bar"
        }, 
        "_id": 0
      }
    }, 
    {
      "$project": {
        "_id": 0, 
        "t": "$__bot"
      }
    }
  ]
  result_set_schema:
    bsonType: object
    properties:
      t:
        bsonType: object
        properties:
          foo: {bsonType: int}
          bar: {bsonType: int}
          car: {bsonType: int}
        required: [bar, car, foo]
        additionalProperties: false
      _id: {bsonType: objectId}
    required: [_id, t]
    additionalProperties: false
- description: WITH clause multiple derived with a join
  current_db: mydb
  "pipeline": [
    {
      "$project": {
        "_id": 0, 
        "biz": "$$ROOT"
      }
    }, 
    {
      "$project": {
        "__bot": {
          "_id": "$biz._id", 
          "foo": "$biz.foo"
        }, 
        "_id": 0
      }
    }, 
    {
      "$project": {
        "_id": 0, 
        "t": "$__bot"
      }
    }, 
    {
      "$lookup": {
        "from": "baz", 
        "pipeline": [
          {
            "$match": {
              "$expr": {
                "$gt": [
                  "$_id", 
                  {
                    "$literal": null
                  }
                ]
              }
            }
          }, 
          {
            "$project": {
              "_id": 0, 
              "baz": "$$ROOT"
            }
          }, 
          {
            "$project": {
              "__bot": {
                "car": "$baz.car", 
                "_id": "$baz._id", 
                "bar": "$baz.bar"
              }, 
              "_id": 0
            }
          }, 
          {
            "$project": {
              "_id": 0, 
              "u": "$__bot"
            }
          }, 
          {
            "$match": {
              "$expr": {
                "$eq": [
                  "$$vt_0._id", 
                  "$u._id"
                ]
              }
            }
          }
        ], 
        "let": {
          "vt_0": "$t"
        }, 
        "as": "eca58228-b657-498a-b76e-f48a9161a404"
      }
    }, 
    {
      "$unwind": {
        "path": "$eca58228-b657-498a-b76e-f48a9161a404"
      }
    }, 
    {
      "$replaceWith": {
        "$mergeObjects": [
          "$$ROOT", 
          "$eca58228-b657-498a-b76e-f48a9161a404"
        ]
      }
    }, 
    {
      "$project": {
        "eca58228-b657-498a-b76e-f48a9161a404": 0, 
        "_id": 0
      }
    }
  ]
  result_set_schema:
    bsonType: object
    properties:
      _id: {bsonType: objectId}
      t:
        bsonType: object
        properties:
          _id: {bsonType: int}
          foo: {bsonType: int}
        required: [_id, foo]
        additionalProperties: false
      u:
        bsonType: object
        properties:
          _id: {bsonType: int}
          car: {bsonType: int}
          bar: {bsonType: int}
        required: [_id, bar, car]
        additionalProperties: false
    required: [_id, t, u]
    additionalProperties: false
- description: WITH clause filters
  current_db: mydb
  pipeline:
- $match:
    $expr:
      $gt:
      - $foo
      - $literal: 1
- $project:
    biz: $$ROOT
    _id: 0
- $project:
    __bot:
      foo: $biz.foo
    _id: 0
- $project:
    t: $__bot
    _id: 0
- $lookup:
    from: bar
    pipeline:
    - $match:
        $expr:
          $and:
          - $gt:
            - $baz
            - $literal: null
          - $gt:
            - $baz
            - $literal: 1
    - $project:
        bar: $$ROOT
        _id: 0
    - $project:
        __bot:
          baz: $bar.baz
        _id: 0
    - $project:
        u: $__bot
        _id: 0
    as: eca58228-b657-498a-b76e-f48a9161a404
- $unwind:
    path: $eca58228-b657-498a-b76e-f48a9161a404
- $replaceWith:
    $mergeObjects:
    - $$ROOT
    - $eca58228-b657-498a-b76e-f48a9161a404
- $project:
    _id: 0
    eca58228-b657-498a-b76e-f48a9161a404: 0
- $project:
    __bot:
      foo: $t.foo
      baz: $u.baz
    _id: 0
- $replaceWith:
    $unsetField:
      field: __bot
      input:
        $setField:
          field: ''
          input: $$ROOT
          value: $__bot
  result_set_schema:
    bsonType: object
    properties:
      _id: {bsonType: objectId}
      '':
        bsonType: object
        properties:
          baz: {bsonType: int}
          foo: {bsonType: int}
        required: [baz, foo]
        additionalProperties: false
    required: ['', _id]
    additionalProperties: false
